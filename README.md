# UCU AWS Project
Final project of UCU cloud computing course 

## About
Cloudformation template creates following resources:
 - S3 bucket for storing files
 - DynamoDB table for storing files' associated information 
 - Lambda function for performing manipulation on S3 and DynamoDB
 - APIGateWay for mapping http requests to Lambda
 - CloudFront for faster site distribution
 - Cognito as IdP for authorizing users
 - Other supporting resources (Roles, Groups, Policies, etc)
 
Site that is stored on one of S3 buckets provide access for the following screens:
 - Home screen (general info, login btn, profile btn)
 - Profile screen (files list, upload file, delete file)
 
## Deploy
1. get available cf-templates buckets `aws s3 ls | grep cf-templates`
2. run aws cli `package` command to upload lambdas to s3
3. `deploy` stack with template generated by prev command
4. get `Outputs` of stack 
5. add `.env.prod` file in site folder with `API_URL` and `AUTH_URL` variables (take values from `Outputs`)
6. run `npm run build` in site folder
7. load files from `public` folder to s3 bucket associated with CloudFront 
8. run invalidation on CloudFront distribution

## AWS CLI

Package local artifacts (lambda) 
```
$ aws cloudformation package --template-file cloudformation.template.yaml --s3-bucket cf-templates-ntiva6yo8mwb-us-east-2 --output-template-file cloudformation.yaml --profile personal
```

Deploy stack
```
$ aws cloudformation deploy --template-file cloudformation.yaml --stack-name uap6 --capabilities CAPABILITY_NAMED_IAM --profile personal 
```

Get created stacks names
```
$ aws cloudformation list-stacks --stack-status-filter UPDATE_COMPLETE --query "StackSummaries[*].StackName" --profile personal
```

Update stack
```
$ aws cloudformation update-stack --template-body file://cloudformation.yaml  --stack-name ucu-aws-project --capabilities CAPABILITY_NAMED_IAM --profile personal
```

Get 5 last stack events
```
$ aws cloudformation describe-stack-events --stack-name ucu-aws-project --query "StackEvents[0:5].[ResourceStatus,LogicalResourceId]" --profile personal
```

## Auth

To use correct auth url the following placeholder should be filled:
- `DOMAIN` - amazon cognito domain prefix
- `CLIENT_ID` - id generated by aws during cloudformation
- `REDIRECT_URI` - path where user will be redirected after login

All of this can be found in **Output** tab of cloudformation console 

```
https://<DOMAIN>.auth.us-east-2.amazoncognito.com/login?response_type=token&client_id=<CLIENT_ID>&redirect_uri=<REDIRECT_URI>
```
Example Login URL
```
https://ucu-project.auth.us-east-2.amazoncognito.com/login?response_type=token&client_id=btjd8prfjhn7l840s55b1ls9m&redirect_uri=https%3A%2F%2Fwww.google.com
```
